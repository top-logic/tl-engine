<?xml version="1.0" encoding="utf-8" ?>

<config:template-call
	xmlns:config="http://www.top-logic.com/ns/config/6.0"
	template="tl-graphic-blocks-server/flowChart.template.xml"
>
	<arguments model="selection(com.top_logic.demo/technical/components/flowchart1/productsContextList.layout.xml#List)">
		<dialogs>
			<layout-reference resource="com.top_logic.demo/technical/components/flowchart1/products/constructionPlan/addPart/dialog.layout.xml"/>
			<layout-reference resource="com.top_logic.demo/technical/components/flowchart1/products/constructionPlan/componentProperties/dialog.layout.xml"/>
			<layout-reference resource="com.top_logic.demo/technical/components/flowchart1/products/constructionPlan/createUsage/dialog.layout.xml"/>
		</dialogs>
		<name key="dynamic.90e02e7f-5528-47f0-bfaf-ffc41a982587">
			<en>Construction plan</en>
			<de>Bauplan</de>
		</name>
		<modelBuilder class="com.top_logic.graphic.flow.server.ui.ScriptFlowChartBuilder">
			<create-chart><![CDATA[model -> {

// All parts.
parts = $model.get(`test.flowchart:Product#buildInstructions`);

nodes = $parts.map(p -> flowSelection(
    userObject: $p,
    content: flowBorder(stroke: "#eccf33", thickness: 2, cssClass:"tlSelectionMarker", 
    content: flowFill(fill: "#ffee95", cssClass:"tlSelectionMarker", 
    content: flowPadding(all: 3, 
    content: flowVertical(
        contents: [
            $p.get(`test.flowchart:FlowNode#marker`).with(marker ->
                $marker.isEmpty()
                    ? flowEmpty()
                    : flowPadding(bottom: 8, content: flowAlign(
                        hAlign: "middle", 
                        content: 
                            flowBorder(
                                stroke: "red", 
                                dashes: [5, 5], 
                                content: flowPadding(
                                    all: 4, 
                                    content: flowText($marker)))))
            ),

            // Node name
            flowAlign(
                hAlign: "middle", 
                content: flowPadding(
                    all: 4, 
                    content: flowText(
                        fontWeight: "bold",
                        text: $p.get(`test.flowchart:FlowNode#name`))
            )),
            
            // Node location grid
            flowAlign(
                hAlign: "middle",  content: flowGrid(
                gapY: -1, 
                // Array with rows
                contents: $p.get(`test.flowchart:FlowNode#locations`).map(l -> [
                    $l.get(`test.flowchart:Location#count`).with(count -> 
                        $count == null 
                        ? flowEmpty() 
                        : flowBorder(
                            right: false,  
                            content: flowPadding(all: 3, content: flowText($count)))
                    ),
                    flowBorder(
                        content: flowFill(
                            fill: $l.get(`test.flowchart:Location#part`)
                                .get(`test.flowchart:Part#color`), 
                            content: 
                                flowPadding(all: 3, content: flowText($l.get(`test.flowchart:Location#part`)))
                        )
                    ),
                    {
                        usages = $l.get(`test.flowchart:Location#usages`);
                        $usages.isEmpty() 
                            ? flowEmpty() 
                            : flowAlign(
                                content: flowBorder(
                                    left: false, 
                                    content: flowPadding(all: 3, content: flowText($usages))))
                    }
                ])
            )),
            
            // Node image
            $p.get(`test.flowchart:FlowNode#image`).with(image -> 
                $image == null
                ? flowEmpty() 
                : flowPadding(
                    top: 8, 
                    content: flowBorder(flowImage($image)))
            )
        ]))))
        )
    );

nodeByPart = $nodes.indexBy(n -> $n["userObject"]);

flowChart(
    root: flowPadding(all: 16, 
        content: flowTree(
            nodes: $nodes,
            connections: $parts
                .filter(p -> !$p.get(`test.flowchart:FlowNode#inputs`).isEmpty())
                .map(p -> $p
                    .get(`test.flowchart:FlowNode#inputs`)
                    .map(c -> flowConnection(
                        parent: $nodeByPart[$p],
                        child: $nodeByPart[$c])))
                .flatten()
        )
    )
);

}]]></create-chart>
		</modelBuilder>
		<buttons>
			<button id="ID_6e8ce086_9a2c_4deb_9570_8ef943486a8c"
				class="com.top_logic.layout.form.component.InvalidateCommand"
			/>
			<button id="ID_cf346e3d_eacf_410a_8ee4_ede994013f70"
				class="com.top_logic.layout.component.GenericDeleteCommandHandler"
				target="selection(self())"
			>
				<resourceKey key="dynamic.d7f1be23-a60a-4f01-9be0-75189c27bc39">
					<en>Delete selected component</en>
					<de>Selektiertes Bauteil l√∂schen</de>
				</resourceKey>
				<confirmation class="com.top_logic.tool.boundsec.confirm.DefaultDeleteConfirmation"/>
			</button>
			<button id="ID_e0339c1d_bda2_45cf_89c4_7e7a52e65fef"
				class="com.top_logic.model.search.providers.CommandHandlerByExpression"
				clique="exportButtons"
				group="Export"
				image="css:fa-solid fa-file-pdf"
				target="diagram(self())"
			>
				<resourceKey key="dynamic.10ba1e96-2e3b-4236-aa33-a5f173144aec">
					<en>Download as PDF</en>
					<de>Als PDF herunterladen</de>
				</resourceKey>
				<operation><![CDATA[diagram -> pdfFile({{{
<h1>Bauplan</h1>
<div>
    <img style="width:100%; height: 800px;" 
        src="data:image/svg+xml;base64,{$diagram.flowSvg().base64Encode()}"/>
</div>
}}}, landscape:true)]]></operation>
				<postCreateActions>
					<deliverAsDownload>
						<input/>
					</deliverAsDownload>
				</postCreateActions>
			</button>
		</buttons>
	</arguments>
</config:template-call>